# %% [markdown]
# # Extracci√≥n Simplificada de Issues desde SonarCloud
# 
# Este notebook te permite extraer todos los issues de un proyecto espec√≠fico de SonarCloud utilizando √∫nicamente el ProjectKey.
# 
# ## Caracter√≠sticas:
# - **Entrada simple**: Solo necesitas el ProjectKey del proyecto
# - **Extracci√≥n completa**: Obtiene todos los issues del proyecto
# - **Agrupaci√≥n autom√°tica**: Presenta los issues organizados por categor√≠as
# - **Visualizaci√≥n clara**: Muestra los resultados de forma f√°cil de entender
# 
# ## ¬øQu√© informaci√≥n obtienes?
# - Issues agrupados por severidad (CRITICAL, MAJOR, MINOR, etc.)
# - Issues agrupados por tipo (BUG, VULNERABILITY, CODE_SMELL)
# - Issues agrupados por regla aplicada
# - Detalles de cada issue incluyendo archivo y l√≠nea afectada

# %%
# Importar librer√≠as necesarias
import requests
import pandas as pd
import json
from collections import defaultdict
import time

print("‚úÖ Librer√≠as importadas correctamente")

# %%
# Configuraci√≥n de SonarCloud
SONARCLOUD_BASE_URL = "https://sonarcloud.io/api"
ISSUES_ENDPOINT = f"{SONARCLOUD_BASE_URL}/issues/search"

def extraer_issues_proyecto(project_key, max_issues=10000):
    """
    Extrae todos los issues de un proyecto de SonarCloud
    
    Args:
        project_key (str): Clave del proyecto en SonarCloud
        max_issues (int): N√∫mero m√°ximo de issues a extraer
    
    Returns:
        list: Lista de issues extra√≠dos
    """
    all_issues = []
    page = 1
    page_size = 500  # M√°ximo permitido por SonarCloud
    
    print(f"üîç Extrayendo issues del proyecto: {project_key}")
    
    while len(all_issues) < max_issues:
        params = {
            'componentKeys': project_key,
            'p': page,
            'ps': page_size,
            'resolved': 'false'  # Solo issues no resueltos
        }
        
        try:
            response = requests.get(ISSUES_ENDPOINT, params=params)
            
            if response.status_code == 200:
                data = response.json()
                issues = data.get('issues', [])
                
                if not issues:
                    break
                
                all_issues.extend(issues)
                print(f"üìÑ P√°gina {page}: {len(issues)} issues extra√≠dos (Total: {len(all_issues)})")
                
                # Verificar si hay m√°s p√°ginas
                total_issues = data.get('total', 0)
                if len(all_issues) >= total_issues:
                    break
                
                page += 1
                time.sleep(0.5)  # Pausa para evitar rate limiting
                
            elif response.status_code == 404:
                print(f"‚ùå Proyecto no encontrado: {project_key}")
                break
            else:
                print(f"‚ùå Error {response.status_code}: {response.text}")
                break
                
        except requests.exceptions.RequestException as e:
            print(f"‚ùå Error de conexi√≥n: {e}")
            break
    
    print(f"‚úÖ Extracci√≥n completada: {len(all_issues)} issues totales")
    return all_issues

print("‚úÖ Funci√≥n de extracci√≥n definida")

# %%
def procesar_y_agrupar_issues(issues_data):
    """
    Procesa y agrupa los issues extra√≠dos
    
    Args:
        issues_data (list): Lista de issues de SonarCloud
    
    Returns:
        dict: Diccionario con issues agrupados por diferentes categor√≠as
    """
    if not issues_data:
        return {}
    
    # Crear agrupaciones
    agrupaciones = {
        'por_severidad': defaultdict(list),
        'por_tipo': defaultdict(list),
        'por_regla': defaultdict(list),
        'por_archivo': defaultdict(list)
    }
    
    for issue in issues_data:
        # Informaci√≥n b√°sica del issue
        issue_info = {
            'key': issue.get('key', ''),
            'message': issue.get('message', ''),
            'severity': issue.get('severity', 'UNKNOWN'),
            'type': issue.get('type', 'UNKNOWN'),
            'rule': issue.get('rule', 'UNKNOWN'),
            'component': issue.get('component', ''),
            'line': issue.get('line', 'N/A'),
            'status': issue.get('status', 'UNKNOWN')
        }
        
        # Agrupar por severidad
        agrupaciones['por_severidad'][issue_info['severity']].append(issue_info)
        
        # Agrupar por tipo
        agrupaciones['por_tipo'][issue_info['type']].append(issue_info)
        
        # Agrupar por regla
        agrupaciones['por_regla'][issue_info['rule']].append(issue_info)
        
        # Agrupar por archivo
        archivo = issue_info['component'].split(':')[-1] if ':' in issue_info['component'] else issue_info['component']
        agrupaciones['por_archivo'][archivo].append(issue_info)
    
    return agrupaciones

def mostrar_resumen_agrupaciones(agrupaciones):
    """
    Muestra un resumen de las agrupaciones de issues
    """
    if not agrupaciones:
        print("‚ùå No hay issues para mostrar")
        return
    
    print("\n" + "="*60)
    print("üìä RESUMEN DE ISSUES AGRUPADOS")
    print("="*60)
    
    # Resumen por severidad
    print("\nüî• ISSUES POR SEVERIDAD:")
    for severidad, issues in sorted(agrupaciones['por_severidad'].items()):
        print(f"  ‚Ä¢ {severidad}: {len(issues)} issues")
    
    # Resumen por tipo
    print("\nüè∑Ô∏è ISSUES POR TIPO:")
    for tipo, issues in sorted(agrupaciones['por_tipo'].items()):
        print(f"  ‚Ä¢ {tipo}: {len(issues)} issues")
    
    # Top 10 reglas m√°s frecuentes
    print("\nüìú TOP 10 REGLAS M√ÅS FRECUENTES:")
    reglas_ordenadas = sorted(agrupaciones['por_regla'].items(), key=lambda x: len(x[1]), reverse=True)
    for i, (regla, issues) in enumerate(reglas_ordenadas[:10], 1):
        print(f"  {i:2d}. {regla}: {len(issues)} issues")
    
    # Top 10 archivos m√°s problem√°ticos
    print("\nüìÅ TOP 10 ARCHIVOS M√ÅS PROBLEM√ÅTICOS:")
    archivos_ordenados = sorted(agrupaciones['por_archivo'].items(), key=lambda x: len(x[1]), reverse=True)
    for i, (archivo, issues) in enumerate(archivos_ordenados[:10], 1):
        print(f"  {i:2d}. {archivo}: {len(issues)} issues")

print("‚úÖ Funciones de procesamiento y visualizaci√≥n definidas")

# %%
def mostrar_detalles_agrupacion(agrupaciones, tipo_agrupacion, nombre_grupo, max_issues=10):
    """
    Muestra los detalles de un grupo espec√≠fico de issues
    
    Args:
        agrupaciones (dict): Diccionario con agrupaciones
        tipo_agrupacion (str): Tipo de agrupaci√≥n ('por_severidad', 'por_tipo', etc.)
        nombre_grupo (str): Nombre del grupo espec√≠fico
        max_issues (int): N√∫mero m√°ximo de issues a mostrar
    """
    if tipo_agrupacion not in agrupaciones:
        print(f"‚ùå Tipo de agrupaci√≥n '{tipo_agrupacion}' no encontrado")
        return
    
    if nombre_grupo not in agrupaciones[tipo_agrupacion]:
        print(f"‚ùå Grupo '{nombre_grupo}' no encontrado en '{tipo_agrupacion}'")
        print(f"Grupos disponibles: {list(agrupaciones[tipo_agrupacion].keys())}")
        return
    
    issues = agrupaciones[tipo_agrupacion][nombre_grupo]
    total_issues = len(issues)
    
    print(f"\n{'='*80}")
    print(f"üìã DETALLES - {tipo_agrupacion.replace('_', ' ').upper()}: {nombre_grupo}")
    print(f"Total de issues: {total_issues}")
    print(f"Mostrando: {min(max_issues, total_issues)} issues")
    print(f"{'='*80}")
    
    for i, issue in enumerate(issues[:max_issues], 1):
        print(f"\n{i:2d}. üîç Issue: {issue['key']}")
        print(f"    üìù Mensaje: {issue['message']}")
        print(f"    üî• Severidad: {issue['severity']}")
        print(f"    üè∑Ô∏è  Tipo: {issue['type']}")
        print(f"    üìú Regla: {issue['rule']}")
        print(f"    üìÅ Archivo: {issue['component'].split(':')[-1] if ':' in issue['component'] else issue['component']}")
        print(f"    üìç L√≠nea: {issue['line']}")
        print(f"    ‚è∏Ô∏è  Estado: {issue['status']}")
    
    if total_issues > max_issues:
        print(f"\n... y {total_issues - max_issues} issues m√°s")

print("‚úÖ Funci√≥n de detalles definida")

# %% [markdown]
# ## üöÄ Extracci√≥n de Issues
# 
# **Instrucciones:**
# 1. Ejecuta la celda siguiente
# 2. Ingresa el ProjectKey cuando se te solicite
# 3. Espera a que se complete la extracci√≥n
# 4. Revisa los resultados agrupados

# %%
# üéØ EXTRACCI√ìN PRINCIPAL
# Solicitar ProjectKey al usuario
project_key = input("üîë Ingresa el ProjectKey del proyecto de SonarCloud: ").strip()

if not project_key:
    print("‚ùå ProjectKey no puede estar vac√≠o")
else:
    print(f"\nüöÄ Iniciando extracci√≥n para el proyecto: {project_key}")
    print("-" * 60)
    
    # Extraer issues
    issues_extraidos = extraer_issues_proyecto(project_key)
    
        # Crear DataFrame
    df_issues = pd.DataFrame(issues_extraidos)
    
    # Nombre del archivo
    nombre_archivo = f"General_issues_10.csv"
    
    # Guardar archivo
    df_issues.to_csv(nombre_archivo, index=False, encoding='utf-8')

    if issues_extraidos:
        # Procesar y agrupar
        agrupaciones = procesar_y_agrupar_issues(issues_extraidos)
        
        # Mostrar resumen
        mostrar_resumen_agrupaciones(agrupaciones)
        
        print(f"\n‚úÖ Extracci√≥n completada exitosamente!")
        print(f"üìä Total de issues extra√≠dos: {len(issues_extraidos)}")
        
        # Guardar variables para uso posterior
        globals()['ultimo_project_key'] = project_key
        globals()['ultimos_issues'] = issues_extraidos
        globals()['ultimas_agrupaciones'] = agrupaciones
        
    else:
        print("‚ùå No se pudieron extraer issues. Verifica el ProjectKey y tu conexi√≥n.")

# %% [markdown]
# ## üîç Exploraci√≥n Detallada
# 
# Usa las siguientes celdas para explorar los issues en detalle:

# %%
# üìã EXPLORAR ISSUES POR SEVERIDAD
# Ejecuta esta celda para ver los issues de una severidad espec√≠fica

if 'ultimas_agrupaciones' in globals():
    print("üî• Severidades disponibles:")
    for severidad in sorted(ultimas_agrupaciones['por_severidad'].keys()):
        count = len(ultimas_agrupaciones['por_severidad'][severidad])
        print(f"  ‚Ä¢ {severidad} ({count} issues)")
    
    print("\nüí° Para ver detalles, ejecuta la siguiente l√≠nea cambiando 'MAJOR' por la severidad deseada:")
    print("mostrar_detalles_agrupacion(ultimas_agrupaciones, 'por_severidad', 'MAJOR', 5)")
    
    # Ejemplo: mostrar issues CRITICAL (si existen)
    if 'CRITICAL' in ultimas_agrupaciones['por_severidad']:
        print("\nüö® Mostrando issues CRITICAL como ejemplo:")
        mostrar_detalles_agrupacion(ultimas_agrupaciones, 'por_severidad', 'CRITICAL', 100)
else:
    print("‚ùå Primero debes extraer issues ejecutando la celda de extracci√≥n")

# %%
# üè∑Ô∏è EXPLORAR ISSUES POR TIPO
# Ejecuta esta celda para ver los issues de un tipo espec√≠fico

if 'ultimas_agrupaciones' in globals():
    print("üè∑Ô∏è Tipos disponibles:")
    for tipo in sorted(ultimas_agrupaciones['por_tipo'].keys()):
        count = len(ultimas_agrupaciones['por_tipo'][tipo])
        print(f"  ‚Ä¢ {tipo} ({count} issues)")
    
    print("\nüí° Para ver detalles, ejecuta la siguiente l√≠nea cambiando 'CODE_SMELL' por el tipo deseado:")
    print("mostrar_detalles_agrupacion(ultimas_agrupaciones, 'por_tipo', 'CODE_SMELL', 5)")
    
    # Ejemplo: mostrar issues de BUGS (si existen)
    if 'BUG' in ultimas_agrupaciones['por_tipo']:
        print("\nüêõ Mostrando BUGS como ejemplo:")
        mostrar_detalles_agrupacion(ultimas_agrupaciones, 'por_tipo', 'BUG', 3)
else:
    print("‚ùå Primero debes extraer issues ejecutando la celda de extracci√≥n")

# %%
# üìú EXPLORAR ISSUES POR REGLA ESPEC√çFICA
# Ejecuta esta celda para ver los issues de una regla espec√≠fica

if 'ultimas_agrupaciones' in globals():
    print("üìú Top 15 reglas m√°s frecuentes:")
    reglas_ordenadas = sorted(ultimas_agrupaciones['por_regla'].items(), 
                             key=lambda x: len(x[1]), reverse=True)
    
    for i, (regla, issues) in enumerate(reglas_ordenadas[:150], 1):
        print(f"  {i:2d}. {regla} ({len(issues)} issues)")
    
    print("\nüí° Para ver detalles de una regla espec√≠fica, copia el nombre de la regla y ejecuta:")
    print("mostrar_detalles_agrupacion(ultimas_agrupaciones, 'por_regla', 'NOMBRE_DE_LA_REGLA', 5)")
    
    # Ejemplo: mostrar la regla m√°s frecuente
    if reglas_ordenadas:
        regla_mas_frecuente = reglas_ordenadas[0][0]
        print(f"\nüìç Mostrando ejemplos de la regla m√°s frecuente: {regla_mas_frecuente}")
        mostrar_detalles_agrupacion(ultimas_agrupaciones, 'por_regla', regla_mas_frecuente, 3)
else:
    print("‚ùå Primero debes extraer issues ejecutando la celda de extracci√≥n")

# %%
# üìÅ EXPLORAR ISSUES POR ARCHIVO
# Ejecuta esta celda para ver los archivos m√°s problem√°ticos

if 'ultimas_agrupaciones' in globals():
    print("üìÅ Top 15 archivos m√°s problem√°ticos:")
    archivos_ordenados = sorted(ultimas_agrupaciones['por_archivo'].items(), 
                               key=lambda x: len(x[1]), reverse=True)
    
    for i, (archivo, issues) in enumerate(archivos_ordenados[:150], 1):
        print(f"  {i:2d}. {archivo} ({len(issues)} issues)")
    
    print("\nüí° Para ver detalles de un archivo espec√≠fico, copia el nombre del archivo y ejecuta:")
    print("mostrar_detalles_agrupacion(ultimas_agrupaciones, 'por_archivo', 'NOMBRE_DEL_ARCHIVO', 5)")
    
    # Ejemplo: mostrar el archivo m√°s problem√°tico
    if archivos_ordenados:
        archivo_mas_problematico = archivos_ordenados[0][0]
        print(f"\nüìç Mostrando issues del archivo m√°s problem√°tico: {archivo_mas_problematico}")
        mostrar_detalles_agrupacion(ultimas_agrupaciones, 'por_archivo', archivo_mas_problematico, 3)
else:
    print("‚ùå Primero debes extraer issues ejecutando la celda de extracci√≥n")

# %% [markdown]
# ## üíæ Exportar Resultados
# 
# Ejecuta la siguiente celda para guardar los resultados en un archivo CSV:

# %%
# üíæ EXPORTAR RESULTADOS A CSV

if 'ultimos_issues' in globals() and 'ultimo_project_key' in globals():
    # Convertir issues a DataFrame
    issues_para_csv = []
    
    for issue in ultimos_issues:
        issue_data = {
            'project_key': ultimo_project_key,
            'issue_key': issue.get('key', ''),
            'message': issue.get('message', ''),
            'severity': issue.get('severity', ''),
            'type': issue.get('type', ''),
            'rule': issue.get('rule', ''),
            'component': issue.get('component', ''),
            'line': issue.get('line', ''),
            'status': issue.get('status', ''),
            'creation_date': issue.get('creationDate', ''),
            'update_date': issue.get('updateDate', '')
        }
        issues_para_csv.append(issue_data)
    
    # Crear DataFrame
    df_issues = pd.DataFrame(issues_para_csv)
    
    # Nombre del archivo
    nombre_archivo = f"issues_{ultimo_project_key.replace(':', '_')}.csv"
    
    # Guardar archivo
    df_issues.to_csv(nombre_archivo, index=False, encoding='utf-8')
    
    print(f"‚úÖ Resultados exportados exitosamente a: {nombre_archivo}")
    print(f"üìä Registros exportados: {len(df_issues)}")
    print(f"üìã Columnas: {list(df_issues.columns)}")
    
    # Mostrar preview
    print("\nüëÄ Vista previa del archivo:")
    print(df_issues.head())
    
else:
    print("‚ùå No hay datos para exportar. Primero extrae issues ejecutando la celda de extracci√≥n.")

# %% [markdown]
# ## üìñ Gu√≠a de Uso
# 
# ### Pasos para usar este notebook:
# 
# 1. **Ejecuta todas las celdas de configuraci√≥n** (las primeras 4 celdas con c√≥digo)
# 2. **Ejecuta la celda de extracci√≥n principal** e ingresa tu ProjectKey
# 3. **Revisa el resumen autom√°tico** que se muestra
# 4. **Explora en detalle** usando las celdas de exploraci√≥n
# 5. **Exporta los resultados** si necesitas un archivo CSV
# 
# ### Ejemplos de ProjectKeys:
# - `organization_project-name`
# - `user_repository-name`
# - `company_application-backend`
# 
# ### Comandos √∫tiles para exploraci√≥n:
# ```python
# # Ver detalles de issues cr√≠ticos
# mostrar_detalles_agrupacion(ultimas_agrupaciones, 'por_severidad', 'CRITICAL', 10)
# 
# # Ver bugs espec√≠ficos
# mostrar_detalles_agrupacion(ultimas_agrupaciones, 'por_tipo', 'BUG', 5)
# 
# # Ver issues de una regla espec√≠fica
# mostrar_detalles_agrupacion(ultimas_agrupaciones, 'por_regla', 'java:S1481', 5)
# 
# # Ver issues de un archivo espec√≠fico
# mostrar_detalles_agrupacion(ultimas_agrupaciones, 'por_archivo', 'Main.java', 10)
# ```

# %%
# üíæ EXPORTAR RESULTADOS A CSV
mostrar_detalles_agrupacion(ultimas_agrupaciones, 'por_severidad', 'MAJOR', 5)